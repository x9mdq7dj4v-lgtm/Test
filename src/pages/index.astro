---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Heyete System Status">
  <div class="status-wrapper">
    <div id="loading" class="loading">ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªä¸­...</div>
    <div id="status-content" style="display: none;">
      </div>
  </div>
</Layout>

<script>
  async function loadStatus() {
    try {
      const rawUrl = 'https://raw.githubusercontent.com/x9mdq7dj4v-lgtm/Test/main/status.json';
      const response = await fetch(`${rawUrl}?t=${new Date().getTime()}`);
      if (!response.ok) throw new Error('Failed to fetch status');
      
      const data = await response.json();
      renderStatus(data);
    } catch (error) {
      document.getElementById('loading')!.innerHTML = 'âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      console.error(error);
    }
  }

  // ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚¹ãƒˆã®HTMLã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function generateServiceGroupHTML(title: string, services: any[]) {
    let html = `<h3 class="group-title">${title}</h3>`;
    html += `<div class="service-list">`;
    
    services.forEach((service: any) => {
      let icon = 'ğŸŸ¢';
      let statusText = 'ç¨¼åƒä¸­';
      let rowClass = 'row-ok';

      if (service.status === 'degraded') {
        icon = 'ğŸŸ¡';
        statusText = 'è­¦å‘Šãƒ»é…å»¶';
        rowClass = 'row-warn';
      } else if (service.status === 'down') {
        icon = 'ğŸ”´';
        statusText = 'åœæ­¢ä¸­';
        rowClass = 'row-down';
      } else if (service.status === 'unknown') {
        icon = 'âšª';
        statusText = 'ä¸æ˜';
        rowClass = 'row-unknown';
      }

      html += `
        <div class="service-row ${rowClass}">
          <div class="service-name">${service.name}</div>
          <div class="service-status">
            ${icon} <span class="status-label">${statusText}</span>
            <span class="latency">(${service.latency_ms || 0} ms)</span>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
    return html;
  }

  function renderStatus(data: any) {
    const container = document.getElementById('status-content')!;
    const loading = document.getElementById('loading')!;
    
    // å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ¤å®š
    const isAllOk = data.system_status === 'all_systems_operational';
    const overallClass = isAllOk ? 'status-ok' : 'status-warning';
    const overallText = isAllOk ? 'âœ… å…¨ã¦ã®ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™' : 'âš ï¸ ä¸€éƒ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™';
    
    const updatedAt = new Date(data.last_updated).toLocaleString('ja-JP');
    
    let html = `
      <div class="overall-banner ${overallClass}">
        <h2>${overallText}</h2>
        <p class="update-time">æœ€çµ‚æ›´æ–°: ${updatedAt}</p>
      </div>
    `;

    // APIã¨Webã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãã‚Œãã‚Œæç”»
    if (data.api_services && data.api_services.length > 0) {
      html += generateServiceGroupHTML('APIã‚µãƒ¼ãƒ“ã‚¹', data.api_services);
    }
    if (data.web_services && data.web_services.length > 0) {
      html += generateServiceGroupHTML('Webã‚µãƒ¼ãƒ“ã‚¹', data.web_services);
    }

    container.innerHTML = html;
    loading.style.display = 'none';
    container.style.display = 'block';
  }

  loadStatus();
  setInterval(loadStatus, 60000);
</script>

<style>
  .status-wrapper {
    margin-top: 2rem;
  }
  .loading {
    text-align: center;
    padding: 3rem;
    color: #666;
  }
  .overall-banner {
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    text-align: center;
  }
  .overall-banner h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
  }
  .update-time {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
  }
  .status-ok {
    background-color: #e6f4ea;
    color: #137333;
  }
  .status-warning {
    background-color: #fef7e0;
    color: #b06000;
  }
  
  .group-title {
    font-size: 1.2rem;
    color: var(--text-color);
    margin: 2rem 0 1rem 0;
    padding-left: 0.5rem;
    border-left: 4px solid #0056b3;
  }

  .service-list {
    background: #fff;
    border: 1px solid #eaeaea;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 2rem;
  }
  .service-row {
    display: flex;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #eaeaea;
  }
  .service-row:last-child {
    border-bottom: none;
  }
  .service-name {
    font-weight: 500;
    font-size: 1.1rem;
  }
  .service-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .latency {
    color: #888;
    font-size: 0.85rem;
    min-width: 60px;
    text-align: right;
  }
</style>
