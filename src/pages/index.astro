---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Heyete System Status">
  <div class="status-wrapper">
    <div id="loading" class="loading">ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªä¸­...</div>
    <div id="status-content" style="display: none;">
      </div>
  </div>
</Layout>

<script>
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å®šæœŸçš„ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã™ã‚‹å‡¦ç†
  async function loadStatus() {
    try {
      // public/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã•ã‚ŒãŸJSONã‚’èª­ã¿è¾¼ã‚€
      const response = await fetch('/status.json?' + new Date().getTime()); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–
      if (!response.ok) throw new Error('Failed to fetch status');
      
      const data = await response.json();
      renderStatus(data);
    } catch (error) {
      document.getElementById('loading')!.innerHTML = 'âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      console.error(error);
    }
  }

  function renderStatus(data: any) {
    const container = document.getElementById('status-content')!;
    const loading = document.getElementById('loading')!;
    
    // å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ¤å®š
    const isAllOk = data.system_status === 'all_systems_operational';
    const overallClass = isAllOk ? 'status-ok' : 'status-warning';
    const overallText = isAllOk ? 'âœ… å…¨ã¦ã®ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™' : 'âš ï¸ ä¸€éƒ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™';
    
    const updatedAt = new Date(data.last_updated).toLocaleString('ja-JP');

    let html = `
      <div class="overall-banner ${overallClass}">
        <h2>${overallText}</h2>
        <p class="update-time">æœ€çµ‚æ›´æ–°: ${updatedAt}</p>
      </div>
      <div class="service-list">
    `;

    // å„ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æç”»
    data.services.forEach((service: any) => {
      let icon = 'ğŸŸ¢';
      let statusText = 'ç¨¼åƒä¸­';
      let rowClass = 'row-ok';

      if (service.status === 'degraded') {
        icon = 'ğŸŸ¡';
        statusText = 'è­¦å‘Šãƒ»é…å»¶';
        rowClass = 'row-warn';
      } else if (service.status === 'down') {
        icon = 'ğŸ”´';
        statusText = 'åœæ­¢ä¸­';
        rowClass = 'row-down';
      } else if (service.status === 'unknown') {
        icon = 'âšª';
        statusText = 'ä¸æ˜';
        rowClass = 'row-unknown';
      }

      html += `
        <div class="service-row ${rowClass}">
          <div class="service-name">${service.name}</div>
          <div class="service-status">
            ${icon} <span class="status-label">${statusText}</span>
            <span class="latency">(${service.latency_ms || 0} ms)</span>
          </div>
        </div>
      `;
    });

    html += `</div>`;
    
    container.innerHTML = html;
    loading.style.display = 'none';
    container.style.display = 'block';
  }

  // åˆå›èª­ã¿è¾¼ã¿ã¨ã€1åˆ†ã”ã¨ã®è‡ªå‹•æ›´æ–°
  loadStatus();
  setInterval(loadStatus, 60000);
</script>

<style>
  .status-wrapper {
    margin-top: 2rem;
  }
  .loading {
    text-align: center;
    padding: 3rem;
    color: #666;
  }
  .overall-banner {
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    text-align: center;
  }
  .overall-banner h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
  }
  .update-time {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
  }
  .status-ok {
    background-color: #e6f4ea;
    color: #137333;
  }
  .status-warning {
    background-color: #fef7e0;
    color: #b06000;
  }
  
  .service-list {
    background: #fff;
    border: 1px solid #eaeaea;
    border-radius: 8px;
    overflow: hidden;
  }
  .service-row {
    display: flex;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #eaeaea;
  }
  .service-row:last-child {
    border-bottom: none;
  }
  .service-name {
    font-weight: 500;
    font-size: 1.1rem;
  }
  .service-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .latency {
    color: #888;
    font-size: 0.85rem;
    min-width: 60px;
    text-align: right;
  }
</style>
