---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Heyete System Status">
  <div class="status-wrapper">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>システムステータスを確認中...</p>
    </div>
    <div id="status-content" style="display: none;"></div>
  </div>
</Layout>

<script>
  // Cookieの操作用ヘルパー関数
  function setHeyeteCookie(name: string, value: string, maxAgeSeconds: number) {
    // ご指定のドメインと厳格なセキュリティ設定
    const domain = "backup-status.heyete.net";
    const options = `max-age=${maxAgeSeconds}; domain=${domain}; path=/; samesite=strict; secure`;
    document.cookie = `${name}=${encodeURIComponent(value)}; ${options}`;
  }

  function getHeyeteCookie(name: string): string | null {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    if (match) return decodeURIComponent(match[2]);
    return null;
  }

  async function loadStatus() {
    const timeCookie = 'h_for-now-lol';
    const dataCookie = 'h_provisional-lol';
    const now = Date.now();

    // 1. Cookieからアクセス時刻を取得し、30秒以内かチェック
    const cachedTimeStr = getHeyeteCookie(timeCookie);
    if (cachedTimeStr) {
      const cachedTime = parseInt(cachedTimeStr, 10);
      if (now - cachedTime < 30000) { // 30秒以内
        const cachedDataStr = getHeyeteCookie(dataCookie);
        if (cachedDataStr) {
          try {
            const data = JSON.parse(cachedDataStr);
            console.log("Cookieからキャッシュされたデータを読み込みました");
            renderStatus(data);
            return; // APIアクセスをスキップ
          } catch(e) {
            console.error('キャッシュデータのパースに失敗しました', e);
          }
        }
      }
    }

    // 2. キャッシュがない、または30秒以上経過している場合はAPIから取得
    try {
      console.log("APIから最新データを取得しています...");
      const rawUrl = 'https://raw.githubusercontent.com/x9mdq7dj4v-lgtm/Test/main/status.json';
      const response = await fetch(`${rawUrl}?t=${new Date().getTime()}`);
      
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();

      // 3. Cookieに保存 (有効期限は60秒)
      setHeyeteCookie(timeCookie, now.toString(), 60);
      setHeyeteCookie(dataCookie, JSON.stringify(data), 60);

      renderStatus(data);
    } catch (error) {
      const loadingEl = document.getElementById('loading');
      if (loadingEl) {
        loadingEl.innerHTML = '<p class="error-text">⚠️ ステータス情報の取得に失敗しました。</p>';
      }
      console.error(error);
    }
  }

  function generateServiceGroupHTML(title: string, services: any[]) {
    let html = `
      <div class="service-group">
        <h3 class="group-title">${title}</h3>
        <div class="service-list">
    `;
    
    services.forEach((service: any) => {
      let statusClass = 'status-dot-ok';
      let statusText = '稼働中';

      if (service.status === 'degraded') {
        statusClass = 'status-dot-warn';
        statusText = '警告・遅延';
      } else if (service.status === 'down') {
        statusClass = 'status-dot-down';
        statusText = '停止中';
      } else if (service.status === 'unknown') {
        statusClass = 'status-dot-unknown';
        statusText = '不明';
      }

      html += `
        <div class="service-row">
          <div class="service-info">
            <span class="service-name">${service.name}</span>
          </div>
          <div class="service-status">
            <span class="latency">${service.latency_ms || 0} ms</span>
            <span class="${statusClass}"></span>
            <span class="status-label">${statusText}</span>
          </div>
        </div>
      `;
    });

    html += `</div></div>`;
    return html;
  }

  function renderStatus(data: any) {
    const container = document.getElementById('status-content')!;
    const loading = document.getElementById('loading')!;
    
    const isAllOk = data.system_status === 'all_systems_operational';
    const overallClass = isAllOk ? 'banner-ok' : 'banner-warning';
    const overallText = isAllOk ? 'すべてのシステムが正常に稼働しています' : '一部のシステムに問題が発生しています';
    
    const updatedAt = new Date(data.last_updated).toLocaleString('ja-JP', {
      month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    });

    let html = `
      <div class="overall-banner ${overallClass}">
        <div class="banner-icon">${isAllOk ? 'SF' : '⚠️'}</div> <div class="banner-text">
          <h2>${overallText}</h2>
          <p class="update-time">最終更新: ${updatedAt}</p>
        </div>
      </div>
    `;

    if (data.api_services && data.api_services.length > 0) {
      html += generateServiceGroupHTML('APIサービス', data.api_services);
    }
    if (data.web_services && data.web_services.length > 0) {
      html += generateServiceGroupHTML('Webサービス', data.web_services);
    }

    container.innerHTML = html;
    loading.style.display = 'none';
    container.style.display = 'block';

    container.style.animation = 'fadeIn 0.6s ease-out forwards';
  }

  // 初回読み込みと60秒ごとの定期チェック（Cookieの有効期限に合わせる）
  loadStatus();
  setInterval(loadStatus, 60000);
</script>

<style>

  :root {
    --bg-color: #f5f5f7;
    --card-bg: rgba(255, 255, 255, 0.8);
    --text-main: #1d1d1f;
    --text-sub: #86868b;
    --border-color: rgba(0, 0, 0, 0.08);
    --green: #34c759;
    --yellow: #ffcc00;
    --red: #ff3b30;
    --gray: #8e8e93;
  }


  .status-wrapper {
    max-width: 860px;
    margin: 3rem auto;
    padding: 0 1.5rem;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, sans-serif;
    color: var(--text-main);
  }

  /* ローディング表示 */
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 5rem 0;
    color: var(--text-sub);
  }
  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border-color);
    border-top-color: var(--text-sub);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }


  .overall-banner {
    display: flex;
    align-items: center;
    padding: 1.5rem 2rem;
    border-radius: 18px;
    margin-bottom: 3rem;
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
  }
  .banner-ok {
    border-left: 6px solid var(--green);
  }
  .banner-warning {
    border-left: 6px solid var(--yellow);
  }
  .banner-icon {
    font-size: 2rem;
    margin-right: 1.5rem;
  }
  .banner-ok .banner-icon {
    color: var(--green);

  }
  .banner-text h2 {
    margin: 0 0 0.3rem 0;
    font-size: 1.3rem;
    font-weight: 600;
    letter-spacing: -0.02em;
  }
  .update-time {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-sub);
  }


  .service-group {
    margin-bottom: 2.5rem;
  }
  .group-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-main);
    margin: 0 0 1rem 1rem;
    letter-spacing: -0.01em;
  }

  /* リストカードデザイン */
  .service-list {
    background: var(--card-bg);
    border-radius: 18px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.03);
    overflow: hidden;
    border: 1px solid var(--border-color);
  }
  .service-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
  }
  .service-row:last-child {
    border-bottom: none;
  }
  .service-row:hover {
    background-color: rgba(0, 0, 0, 0.01);
  }
  
  .service-name {
    font-weight: 500;
    font-size: 1.05rem;
    letter-spacing: -0.01em;
  }

  .service-status {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .latency {
    color: var(--text-sub);
    font-size: 0.85rem;
    font-variant-numeric: tabular-nums;
    margin-right: 0.5rem;
  }

  .status-dot-ok, .status-dot-warn, .status-dot-down, .status-dot-unknown {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
  }
  .status-dot-ok { background-color: var(--green); box-shadow: 0 0 8px rgba(52, 199, 89, 0.4); }
  .status-dot-warn { background-color: var(--yellow); box-shadow: 0 0 8px rgba(255, 204, 0, 0.4); }
  .status-dot-down { background-color: var(--red); box-shadow: 0 0 8px rgba(255, 59, 48, 0.4); }
  .status-dot-unknown { background-color: var(--gray); }

  .status-label {
    font-size: 0.9rem;
    font-weight: 500;
    min-width: 4rem;
  }


  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .error-text {
    color: var(--red);
    font-weight: 500;
  }
</style>
