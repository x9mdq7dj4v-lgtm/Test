name: Update API Status JSON

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-status:
    runs-on: ubuntu-latest
    environment: mine  
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Health and Generate status.json
        env:
          BBS_API_URL: ${{ secrets.BBS_API_URL }}
          RURUNA_API_URL: ${{ secrets.RURUNA_API_URL }}
          SUPPORT_API_URL: ${{ secrets.SUPPORT_API_URL }}
          ACCOUNTS_API_URL: ${{ secrets.ACCOUNTS_API_URL }}
        run: |
          cat << 'EOF' > generate.js
          const fs = require('fs');

          // 1. APIエンドポイント
          const apiEndpoints = [
            { id: 'bbs', name: '24.anon API', url: process.env.BBS_API_URL },
            { id: 'ruruna', name: 'Ruruna AI API', url: process.env.RURUNA_API_URL },
            { id: 'support', name: 'サポートお問い合わせ API', url: process.env.SUPPORT_API_URL },
            { id: 'accounts', name: 'Heyeteアカウント API', url: process.env.ACCOUNTS_API_URL }
          ];

          // 2. Webサーバーエンドポイント
          const webEndpoints = [
            { id: 'web-top', name: '総合トップサイト', url: 'https://www.heyete.com/test.html' },
            { id: 'web-myaccounts', name: 'アカウントダッシュボード', url: 'https://myaccount.heyete.com/test' },
            { id: 'web-accounts', name: 'Heyeteアカウントログイン等', url: 'https://accounts.heyete.com/test' },
            { id: 'web-ruruna', name: 'Ruruna AI', url: 'https://ruruna.heyete.com/test.html' },
            { id: 'web-anon', name: '24.anon', url: 'https://anon.heyete.com/test.html' },
            { id: 'web-news', name: 'Heyete News', url: 'https://news.heyete.com/test.html' },
            { id: 'web-blog', name: 'Heyete Blog', url: 'https://blog.heyete.com/test.html' },
            { id: 'web-dev', name: 'Heyete Developer', url: 'https://dev.heyete.com/test.html' },
            { id: 'web-corp', name: 'コーポレートサイト', url: 'https://corp.heyete.com/test.html' },
            { id: 'web-policies', name: '規約とポリシー', url: 'https://policies.heyete.com/test.html' },
            { id: 'web-support', name: 'サポートお問い合わせ', url: 'https://support.heyete.com/test.html' },
            { id: 'web-docs', name: '資料サイト', url: 'https://docs.heyete.net/test.html' },
            { id: 'web-anon-lite', name: '24.anon 軽量版', url: 'https://anon.heyete.net/test.html' }
          ];

          async function checkEndpoint(ep, isApi) {
            const maxRetries = 1;      // 最大リトライ回数 (最初の1回 + リトライ1回 = 計2回)
            const retryDelayMs = 5000; // リトライ前の待機時間 (5秒)

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
              const start = Date.now();
              try {
                if (!ep.url) {
                  return { id: ep.id, name: ep.name, status: 'unknown', message: 'URL未設定' };
                }

                // 10秒のタイムアウトを設定
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const options = { 
                  signal: controller.signal,
                  headers: {
                    "User-Agent": "HeyeteBot"
                  }
                };

                if (isApi) {
                  options.headers["Origin"] = "https://support.heyete.com";
                }

                const res = await fetch(ep.url, options);
                clearTimeout(timeoutId);
                
                const latency = Date.now() - start;

                if (res.ok) {
                  let status = 'operational';
                  let details = null;

                  if (isApi) {
                    const data = await res.json().catch(() => ({}));
                    const hasDepError = data.dependencies && Object.values(data.dependencies).some(v => String(v).includes('failed') || String(v).includes('error'));
                    if (hasDepError) status = 'degraded';
                    details = data;
                  }

                  // 正常 (operational) なら、ループを抜けて即座に結果を返す
                  if (status === 'operational') {
                    return { id: ep.id, name: ep.name, status, latency_ms: latency, details };
                  } else if (attempt === maxRetries) {
                    // APIの依存エラー等(degraded)で、最後の試行だった場合はその結果を返す
                    return { id: ep.id, name: ep.name, status, latency_ms: latency, details };
                  }
                } else {
                  // 200以外で、最後の試行だった場合はダウンとして返す
                  if (attempt === maxRetries) {
                    return { id: ep.id, name: ep.name, status: 'down', code: res.status, latency_ms: latency };
                  }
                }
              } catch (err) {
                // ネットワークエラー等で、最後の試行だった場合はダウンとして返す
                if (attempt === maxRetries) {
                  return { id: ep.id, name: ep.name, status: 'down', error: err.message };
                }
              }

              // 正常でない（エラー、HTTPステータス異常、またはdegraded）場合は待機してリトライ
              console.log(`[警告] ${ep.name} のチェックに失敗しました。${retryDelayMs / 1000}秒後にリトライします... (試行: ${attempt + 1}/${maxRetries + 1})`);
              await new Promise(resolve => setTimeout(resolve, retryDelayMs));
            }
          }

          async function check() {
            const apiResults = [];
            const webResults = [];

            // APIのチェック
            for (const ep of apiEndpoints) {
              apiResults.push(await checkEndpoint(ep, true));
            }
            // Webのチェック
            for (const ep of webEndpoints) {
              webResults.push(await checkEndpoint(ep, false));
            }
            
            const allResults = [...apiResults, ...webResults];
            const isAllOk = allResults.every(r => r.status === 'operational' || r.status === 'unknown');

            const output = {
              last_updated: new Date().toISOString(),
              system_status: isAllOk ? 'all_systems_operational' : 'partial_outage',
              api_services: apiResults,
              web_services: webResults
            };
            
            fs.writeFileSync('status.json', JSON.stringify(output, null, 2));
            console.log("status.json generated successfully.");
          }
          
          check();
          EOF
          
          node generate.js

      - name: Commit and Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json
          
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update system status [skip ci]" && git push)
